pipeline {
    agent any
    
    triggers {
        GenericTrigger(
            genericVariables: [
                [key: 'GITLAB_HTTP_URL', value: '$.project.http_url'],  // Используем HTTPS вместо SSH
                [key: 'COMMIT_SHA', value: '$.commit.id'],
                [key: 'MR_ID', value: '$.merge_request.iid']
            ],
            token: 'MR_APPROVED_TOKEN'
        )
    }
    
    stages {
        stage('Clone') {
            steps {
                script {
                    // Клонируем через HTTPS (не требует SSH-ключей)
                    sh """
                        git clone ${env.GITLAB_HTTP_URL} repo
                        cd repo
                        git checkout ${env.COMMIT_SHA}
                    """
                }
            }
        }
        
        stage('Process') {
            steps {
                dir('repo') {
                    sh 'git diff HEAD~1 --name-only'  // Пример обработки изменений
                }
            }
        }
    }
}
